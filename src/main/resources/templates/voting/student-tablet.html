<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${stationName} + ' - Voting Tablet'">Voting Tablet</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/voting/student-tablet.css}">
    <style>
        :root {
            --theme-color: #1e3c72;
            --theme-color-light: #eef2f7;
        }
        .header {
            background: var(--theme-color) !important;
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--theme-color) 90%) !important;
        }
        .progress-fill { background-color: var(--theme-color) !important; }
        .btn-next, .btn-submit { background-color: var(--theme-color) !important; }
        .btn-next:hover, .btn-submit:hover { opacity: 0.9; }
        .btn-next:disabled { background-color: #cccccc !important; }
        .candidate-card.selected {
            border-color: var(--theme-color) !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 0 0 2px var(--theme-color) !important;
            background-color: #fff;
        }
        .candidate-icon {
            background-color: var(--theme-color-light);
            color: var(--theme-color);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin: 0 auto 15px;
        }
        .candidate-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
            border: 3px solid var(--theme-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .position-type { color: var(--theme-color) !important; font-weight: 600; }
        .waiting-icon { color: var(--theme-color); }
    </style>
</head>
<body>
<div class="waiting-screen" id="waitingScreen">
    <div class="waiting-icon">üó≥Ô∏è</div>
    <h1>Waiting for Student...</h1>
    <p th:text="${stationName}">Faculty Station</p>
    <div class="connection-status" id="connectionStatus">üî¥ Connecting...</div>
</div>

<div class="voting-screen" id="votingScreen">
    <div class="header">
        <div class="header-left">
            <h1>University Voting System</h1>
            <div class="student-info" id="studentInfo"></div>
        </div>
        <div class="faculty-badge" id="facultyBadge"></div>
    </div>

    <div class="progress-bar">
        <div class="progress-text"><span id="progressText">Position 1</span></div>
        <div class="progress-track"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
    </div>

    <div class="container" id="ballotContainer"></div>
</div>

<div class="modal" id="submitModal">
    <div class="modal-content">
        <div class="modal-icon" style="color: var(--theme-color)">üó≥Ô∏è</div>
        <h3 class="modal-title">Submit Your Vote</h3>
        <p class="modal-text">Are you sure?</p>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeSubmitModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" style="background-color: var(--theme-color); color: white;" onclick="submitVotes()">Submit Vote</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const stationId = /*[[${stationId}]]*/ 'ENG';
    let stompClient = null;
    let sessionData = null;
    let positions = [];
    let currentStep = 0;
    let selectedVotes = {};

    function connect() {
        const socket = new SockJS('/ws-voting');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected';
            stompClient.subscribe('/topic/station/' + stationId, function(message) {
                const data = JSON.parse(message.body);
                handleStationMessage(data);
            });
        });
    }

    function handleStationMessage(data) {
        if (data.action === 'ACTIVATE_BALLOT') {
            sessionData = data.session;
            positions = sessionData.positions || [];
            activateVotingScreen();
        } else if (data.action === 'RESET_BALLOT') {
            resetToWaiting();
        }
    }

    function activateVotingScreen() {
        document.getElementById('waitingScreen').style.display = 'none';
        document.getElementById('votingScreen').style.display = 'block';

        if (sessionData.facultyColor) {
            document.documentElement.style.setProperty('--theme-color', sessionData.facultyColor);
        }

        document.getElementById('studentInfo').innerHTML =
            `<span>Student: ${sessionData.studentName}</span> | <span>ID: ${sessionData.studentId}</span>`;

        const badge = document.getElementById('facultyBadge');
        badge.textContent = sessionData.facultyName;
        badge.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        badge.style.color = 'white';

        buildBallot();
        currentStep = 0;
        selectedVotes = {};
        updateProgress();
    }

    function buildBallot() {
        const container = document.getElementById('ballotContainer');
        container.innerHTML = '';

        positions.forEach((position, index) => {
            const positionCard = document.createElement('div');
            positionCard.className = 'position-card' + (index === 0 ? ' active' : '');
            positionCard.id = 'position-' + position.id;

            positionCard.innerHTML = `
                <div class="position-header">
                    <h2 class="position-title">${position.name}</h2>
                    <p class="position-type">${position.isCommon ? 'Common Position' : sessionData.facultyName + ' Position'}</p>
                </div>
                <div class="candidates-grid">
                    ${position.candidates.map(c => `
                        <div class="candidate-card"
                             data-candidate-id="${c.id}"
                             data-position-id="${position.id}"
                             onclick="selectCandidate(${position.id}, ${c.id})">

                            ${c.imageUrl ?
                `<img src="${c.imageUrl}" class="candidate-img" alt="${c.studentName}">` :
                `<div class="candidate-icon">üë§</div>`
            }

                            <div class="candidate-name">${c.studentName}</div>
                            <div class="candidate-id">${c.studentId}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="button-container">
                    <button class="btn btn-back" onclick="previousPosition()" ${index === 0 ? 'disabled' : ''}>‚Üê Previous</button>
                    <button class="btn btn-next" id="btn-next-${position.id}" onclick="nextPosition()" disabled>Next ‚Üí</button>
                </div>
            `;
            container.appendChild(positionCard);
        });

        const summaryCard = document.createElement('div');
        summaryCard.className = 'summary-card';
        summaryCard.id = 'summaryCard';
        summaryCard.innerHTML = `
            <h2 class="summary-title">Review Your Votes</h2>
            <div id="summaryList"></div>
            <div class="button-container">
                <button class="btn btn-back" onclick="editVotes()">‚Üê Edit Votes</button>
                <button class="btn-submit" onclick="showSubmitConfirmation()">Submit My Vote</button>
            </div>
        `;
        container.appendChild(summaryCard);
    }

    function selectCandidate(positionId, candidateId) {
        document.querySelectorAll(`[data-position-id="${positionId}"]`).forEach(card => card.classList.remove('selected'));
        const selectedCard = document.querySelector(`[data-position-id="${positionId}"][data-candidate-id="${candidateId}"]`);
        selectedCard.classList.add('selected');
        selectedVotes[positionId] = candidateId;
        document.getElementById(`btn-next-${positionId}`).disabled = false;
    }

    function nextPosition() {
        if (currentStep < positions.length - 1) {
            document.getElementById(`position-${positions[currentStep].id}`).classList.remove('active');
            currentStep++;
            document.getElementById(`position-${positions[currentStep].id}`).classList.add('active');
            updateProgress();
        } else {
            showSummary();
        }
    }

    function previousPosition() {
        if (currentStep > 0) {
            document.getElementById(`position-${positions[currentStep].id}`).classList.remove('active');
            currentStep--;
            document.getElementById(`position-${positions[currentStep].id}`).classList.add('active');
            updateProgress();
        }
    }

    function updateProgress() {
        const progress = ((currentStep + 1) / positions.length) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `Position ${currentStep + 1} of ${positions.length}`;
    }

    function showSummary() {
        document.querySelectorAll('.position-card').forEach(card => card.classList.remove('active'));
        const summaryList = document.getElementById('summaryList');
        summaryList.innerHTML = '';
        positions.forEach(position => {
            const candidateId = selectedVotes[position.id];
            const candidate = position.candidates.find(c => c.id === candidateId);
            const imageHtml = candidate.imageUrl ?
                `<img src="${candidate.imageUrl}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:10px;">` : '';

            summaryList.innerHTML += `<div class="summary-item"><div style="display:flex; align-items:center;">${imageHtml}<div><div class="summary-position">${position.name}</div><div class="summary-candidate">${candidate.studentName}</div></div></div></div>`;
        });
        document.getElementById('summaryCard').classList.add('active');
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').textContent = 'Review';
    }

    function editVotes() {
        document.getElementById('summaryCard').classList.remove('active');
        currentStep = 0;
        document.getElementById(`position-${positions[0].id}`).classList.add('active');
        updateProgress();
    }

    function showSubmitConfirmation() { document.getElementById('submitModal').classList.add('active'); }
    function closeSubmitModal() { document.getElementById('submitModal').classList.remove('active'); }

    async function submitVotes() {
        try {
            const response = await fetch('/voting/submit-votes?stationId=' + stationId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId: sessionData.studentId, votes: selectedVotes })
            });
            const data = await response.json();
            if (data.success) { alert('‚úÖ Vote submitted!'); resetToWaiting(); } else { alert('‚ùå ' + data.message); }
        } catch (error) { alert('Error submitting vote'); }
    }

    function resetToWaiting() {
        document.getElementById('votingScreen').style.display = 'none';
        document.getElementById('waitingScreen').style.display = 'flex';
        sessionData = null; positions = []; currentStep = 0; selectedVotes = {};
        closeSubmitModal();
    }

    window.onload = function() { connect(); };
</script>
</body>
</html>