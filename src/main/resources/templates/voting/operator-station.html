<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${stationName} + ' - Operator Station'">Operator Station</title>
    <link rel="stylesheet" th:href="@{/css/voting/operator-station.css}">
</head>
<body>
<div class="container">
    <div class="station-badge" th:style="'background: linear-gradient(135deg, ' + ${facultyColor} + ' 0%, ' + ${facultyColor} + 'dd 100%);'">
        <span th:text="${stationName}">Faculty Station</span>
        <br>
        <span style="font-size: 0.7em; opacity: 0.9; font-weight: normal;" th:text="'CODE: ' + ${stationId}">CODE: ENG</span>
    </div>

    <div class="status-icon">üë§</div>
    <h1>Operator Station</h1>
    <p class="status-text">READY FOR VALIDATION</p>

    <div class="tablet-status">
        <h4>üì± Tablet Status</h4>
        <p>Make sure the tablet is showing "Waiting for student..." screen</p>
    </div>

    <p class="instruction">
        Enter the student's ID to activate their ballot on the tablet
    </p>

    <div class="student-input-container">
        <input type="text" id="studentIdInput" placeholder="Enter Student ID" autofocus autocomplete="off">
    </div>

    <div class="button-group">
        <button class="btn btn-activate" onclick="activateBallot()">
            üöÄ Activate Ballot
        </button>
        <button class="btn btn-reset" onclick="resetTablet()">
            üîÑ Reset Tablet
        </button>
    </div>

    <div class="message" id="message"></div>

    <div class="dashboard-panels">
        <!-- Search Panel -->
        <div class="panel-card">
            <div class="section-title">
                <span>üîç</span> Search Students
            </div>
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" class="search-box"
                       placeholder="Type Name or ID to search..."
                       onkeyup="searchStudents()">

                <div id="searchResults" class="search-results">
                </div>

                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.7; color: white;">
                    üí° Tip: Click on a student from the results to auto-fill their ID.
                </p>
            </div>
        </div>

        <!-- Recent Voters Panel -->
        <div class="panel-card">
            <div class="section-title">
                <span>üïí</span> Recent Voters
            </div>

            <!-- Vote Count Display -->
            <div class="vote-count-box">
                <div class="count-label">Total Votes Cast</div>
                <div class="count-number" id="voteCount">
                    <span class="loading-spinner">‚óè</span>
                </div>
            </div>

            <div class="recent-table-wrapper">
                <table class="recent-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th style="text-align: right">Time</th>
                    </tr>
                    </thead>
                    <tbody id="recentVotesList">
                    <tr>
                        <td colspan="3" class="no-data">
                            Loading recent votes...
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="info-box" style="margin-top: 40px;">
        <h3>üìã Operator Instructions</h3>
        <ol>
            <li><strong>Check Tablet:</strong> Ensure tablet shows "Waiting" screen</li>
            <li><strong>Request ID:</strong> Ask student for their ID card</li>
            <li><strong>Enter ID:</strong> Type student ID carefully</li>
            <li><strong>Activate:</strong> Click "Activate Ballot" button</li>
            <li><strong>Student Votes:</strong> Student completes voting on tablet</li>
            <li><strong>Auto Reset:</strong> Tablet resets automatically after submission</li>
            <li><strong>Manual Reset:</strong> Use "Reset Tablet" if needed</li>
        </ol>
    </div>
</div>

<script th:inline="javascript">
    const stationId = /*[[${stationId}]]*/ 'ENG';
    const facultyColor = /*[[${facultyColor}]]*/ '#1e3c72';

    document.addEventListener('DOMContentLoaded', function() {
        applyFacultyColors();
    });

    function applyFacultyColors() {
        const panelCards = document.querySelectorAll('.panel-card');
        panelCards.forEach(card => {
            card.style.background = `linear-gradient(135deg, ${facultyColor}f0 0%, ${facultyColor}dd 100%)`;
        });

        const voteCountBox = document.querySelector('.vote-count-box');
        if (voteCountBox) {
            voteCountBox.style.background = `rgba(255, 255, 255, 0.15)`;
            voteCountBox.style.borderColor = `rgba(255, 255, 255, 0.3)`;
        }
    }

    document.getElementById('studentIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            activateBallot();
        }
    });

    async function activateBallot(studentIdOverride) {
        const studentId = studentIdOverride || document.getElementById('studentIdInput').value.trim().toUpperCase();

        if (!studentId) {
            showMessage('‚ö†Ô∏è Please enter a Student ID', 'error');
            return;
        }

        try {
            const formData = new URLSearchParams();
            formData.append('studentId', studentId);
            formData.append('stationId', stationId);

            const response = await fetch('/voting/validate-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showMessage('‚úÖ ' + data.message + ' - Ballot is now active on tablet!', 'success');
                document.getElementById('studentIdInput').value = '';

                // Clear search
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').style.display = 'none';

                // Reload recent votes
                loadRecentVotes();
                loadVoteCount();

                setTimeout(() => {
                    document.getElementById('message').style.display = 'none';
                }, 3000);
            } else {
                showMessage('‚ùå ' + data.message, 'error');
            }
            document.getElementById('studentIdInput').focus();
        } catch (error) {
            showMessage('‚ùå Error validating student', 'error');
            console.error(error);
        }
    }

    async function resetTablet() {
        if (!confirm('Are you sure you want to reset the tablet? This will clear any active voting session.')) {
            return;
        }
        try {
            const response = await fetch('/voting/reset-ballot/' + stationId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.success) {
                showMessage('‚úÖ Tablet has been reset successfully', 'success');
                document.getElementById('studentIdInput').value = '';
                document.getElementById('studentIdInput').focus();
            } else {
                showMessage('‚ùå Error resetting tablet', 'error');
            }
        } catch (error) {
            showMessage('‚ùå Error resetting tablet', 'error');
        }
    }

    let searchTimeout;
    async function searchStudents() {
        const query = document.getElementById('searchInput').value.trim();
        const resultsDiv = document.getElementById('searchResults');

        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/voting/operator/search?stationId=${stationId}&query=${encodeURIComponent(query)}`);
                const students = await response.json();
                resultsDiv.innerHTML = '';

                if (students.length > 0) {
                    students.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = `
                            <div class="student-details">
                                <strong>${s.fullName}</strong>
                                <small>${s.studentId}</small>
                            </div>
                            ${s.hasVoted ?
                            '<span class="badge-voted">Already Voted</span>' :
                            '<span class="badge-ready">Ready</span>'}
                        `;
                        if (!s.hasVoted) {
                            div.onclick = () => {
                                document.getElementById('studentIdInput').value = s.studentId;
                                document.getElementById('searchInput').value = '';
                                resultsDiv.style.display = 'none';
                                activateBallot(s.studentId);
                            };
                        } else {
                            div.style.opacity = '0.6';
                            div.style.cursor = 'not-allowed';
                            div.title = "Student has already voted";
                        }
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="search-item" style="color:#666; justify-content:center;">No students found</div>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error("Search error", error);
                resultsDiv.innerHTML = '<div class="search-item" style="color:#c33; justify-content:center;">Error loading results</div>';
                resultsDiv.style.display = 'block';
            }
        }, 300);
    }

    async function loadRecentVotes() {
        try {
            const response = await fetch(`/voting/operator/recent?stationId=${stationId}`);

            if (!response.ok) {
                throw new Error('Failed to load recent votes');
            }

            const votes = await response.json();
            const tbody = document.getElementById('recentVotesList');
            tbody.innerHTML = '';

            if (votes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="no-data">No recent votes yet</td></tr>';
            } else {
                votes.forEach(v => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><code>${v.studentId}</code></td>
                        <td>${v.fullName}</td>
                        <td class="time-col">${v.votedAt}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Recent votes error:", error);
            const tbody = document.getElementById('recentVotesList');
            tbody.innerHTML = '<tr><td colspan="3" class="no-data" style="color: #ff4757;">Error loading recent votes</td></tr>';
        }
    }

    async function loadVoteCount() {
        try {
            const response = await fetch(`/voting/operator/vote-count?stationId=${stationId}`);

            if (!response.ok) {
                throw new Error('Failed to load vote count');
            }

            const data = await response.json();
            const countElement = document.getElementById('voteCount');
            countElement.innerHTML = `<span class="count-animated">${data.count}</span>`;
        } catch (error) {
            console.error("Vote count error:", error);
            const countElement = document.getElementById('voteCount');
            countElement.innerHTML = '<span style="color: #ff4757; font-size: 0.8em;">Error</span>';
        }
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = 'message ' + type;
        messageDiv.style.display = 'block';
    }

    // Initial load
    loadRecentVotes();
    loadVoteCount();

    // Auto-refresh every 5 seconds
    setInterval(loadRecentVotes, 5000);
    setInterval(loadVoteCount, 5000);
</script>
</body>
</html>